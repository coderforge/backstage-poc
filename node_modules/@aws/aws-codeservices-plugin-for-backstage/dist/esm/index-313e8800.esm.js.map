{"version":3,"file":"index-313e8800.esm.js","sources":["../../src/hooks/useCodePipelineSummary.ts","../../src/components/CodePipelineWidget/CodePipelineWidget.tsx"],"sourcesContent":["/**\n * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\").\n * You may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *     http://www.apache.org/licenses/LICENSE-2.0\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { useAsyncRetry } from \"react-use\";\nimport { useApi } from \"@backstage/core-plugin-api\";\nimport { GetPipelineStateOutput } from \"@aws-sdk/client-codepipeline\";\nimport { awsCodePipelineApiRef } from \"../api/AwsCodePipelineApi\";\n\nexport function useCodePipelineSummary(arn: string) {\n  const api = useApi(awsCodePipelineApiRef);\n\n  const {\n    loading,\n    value: pipelineInfo,\n    error,\n    retry,\n  } = useAsyncRetry<GetPipelineStateOutput>(async () => {\n    return await api.getPipelineState({ arn });\n  }, []);\n\n  return { loading, pipelineInfo, error, retry } as const;\n}\n","/**\n * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the \"License\").\n * You may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *     http://www.apache.org/licenses/LICENSE-2.0\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  GetPipelineStateOutput,\n  StageState,\n} from \"@aws-sdk/client-codepipeline\";\nimport { Entity } from \"@backstage/catalog-model\";\nimport {\n  InfoCard,\n  InfoCardVariants,\n  MissingAnnotationEmptyState,\n  ResponseErrorPanel,\n  Table,\n  TableColumn,\n} from \"@backstage/core-components\";\nimport { useEntity } from \"@backstage/plugin-catalog-react\";\nimport { Box, Grid, LinearProgress, Link } from \"@material-ui/core\";\nimport React from \"react\";\nimport { AWS_CODEPIPELINE_ARN_ANNOTATION } from \"../../constants\";\nimport { useCodePipelineSummary } from \"../../hooks\";\nimport { getCodePipelineArnFromEntity } from \"../../utils\";\nimport { AboutField } from \"../AboutField\";\nimport { isAWSCodePipelineAvailable } from \"../Flags\";\nimport { PipelineStageStatus } from \"../PipelineStageStatus\";\n\nconst PipelineStageTable = ({ stages }: { stages: StageState[] }) => {\n  const columns: TableColumn[] = [\n    {\n      title: \"Stage\",\n      field: \"id\",\n      render: (row: Partial<StageState>) => {\n        return row.stageName;\n      },\n    },\n    {\n      title: \"Status\",\n      field: \"deploymentStatus\",\n      render: (row: Partial<StageState>) => (\n        <PipelineStageStatus status={row.latestExecution?.status} />\n      ),\n    },\n  ];\n\n  return (\n    <div>\n      <Table\n        options={{\n          paging: false,\n          search: false,\n          toolbar: false,\n          padding: \"dense\",\n        }}\n        data={stages}\n        columns={columns}\n      />\n    </div>\n  );\n};\n\nconst PipelineWidgetContent = ({\n  pipelineState,\n  region,\n}: {\n  pipelineState: GetPipelineStateOutput;\n  region: string;\n}) => {\n  const pipelineUrl = `https://${region}.console.aws.amazon.com/codesuite/codepipeline/pipelines/${pipelineState.pipelineName}/view?region=${region}`;\n\n  return (\n    <InfoCard title=\"AWS CodePipeline\" noPadding>\n      <Box sx={{ m: 2 }}>\n        <Grid container>\n          <AboutField label=\"Pipeline Name\" gridSizes={{ md: 12 }}>\n            <Link href={pipelineUrl} target=\"_blank\">\n              {pipelineState.pipelineName}\n            </Link>\n          </AboutField>\n        </Grid>\n      </Box>\n      <PipelineStageTable stages={pipelineState.stageStates ?? []} />\n    </InfoCard>\n  );\n};\n\nconst PipelineLatestRunCard = ({\n  entity,\n  variant,\n}: {\n  entity: Entity;\n  variant?: InfoCardVariants;\n}) => {\n  const { region, arn } = getCodePipelineArnFromEntity(entity);\n\n  const { pipelineInfo, error, loading } = useCodePipelineSummary(arn);\n\n  if (pipelineInfo) {\n    return (\n      <PipelineWidgetContent pipelineState={pipelineInfo} region={region} />\n    );\n  }\n\n  return (\n    <InfoCard title=\"AWS CodePipeline\" variant={variant}>\n      {error && <ResponseErrorPanel error={error} />}\n\n      {loading && <LinearProgress />}\n    </InfoCard>\n  );\n};\n\nexport const AWSCodePipelineWidget = ({\n  variant,\n}: {\n  variant?: InfoCardVariants;\n}) => {\n  const { entity } = useEntity();\n  return !isAWSCodePipelineAvailable(entity) ? (\n    <MissingAnnotationEmptyState annotation={AWS_CODEPIPELINE_ARN_ANNOTATION} />\n  ) : (\n    <PipelineLatestRunCard entity={entity} variant={variant} />\n  );\n};\n"],"names":[],"mappings":"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"}